---
jobs:
- name: CD-Build
  public: true
  serial: true
  plan:
  - get: app-version
    resource: resource-app-version
    params:
      bump: patch
  - task: display-version
    config:
      platform: linux
      image: docker:///ubuntu#14.04
      inputs:
      - name: app-version
      run:
        path: cat
        args: [app-version/number]
  - get: citytest
    trigger: true

  - task: build-citytest
    config:
      platform: linux
      image: docker:///bamdad/jdk8-gradle
      inputs:
      - name: app-version
      inputs:
      - name: citytest
        path: .
      run:
        path: ./task_gradle_build.sh
        args: [app-version/number]
      params: {a: b}

  - { task: build-gradle, file: citytest/task_gradle_build.yml }	
  - put: build_artifact
    params:
      from: build-gradle/build/libs/cities-0.0.1-SNAPSHOT.jar
  - put: build_manifest
    params:
      from: build-gradle/manifest.yml

- name: CD-Deploy
  plan:
  - get: build_artifact
    trigger: true
    passed: [CD-Build]
  - get: build_manifest
    trigger: true
    passed: [CD-Build]
  - put: resource-deploy-web-app
    params:
      manifest: build_manifest/manifest.yml
      path: build_artifact/cities-0.0.1.jar

resources:
- name: citytest
  type: git
  source:
    uri: https://github.com/rgadhia/citytest

- name: build_artifact
  type: s3
  source:
    access_key_id: {{aws-access-key-id}}
    secret_access_key: {{aws-secret-access-key}}
    bucket: rgadhia-citytest-artifacts
    region_name: us-east-1
    versioned_file: cities-0.0.1.jar

- name: build_manifest
  type: s3
  source:
    access_key_id: {{aws-access-key-id}}
    secret_access_key: {{aws-secret-access-key}}
    bucket: rgadhia-citytest-artifacts
    region_name: us-east-1
    versioned_file: manifest.yml

- name: resource-deploy-web-app
  type: cf
  source:
    api: https://api.run.pivotal.io
    username: {{pcf-username}}
    password: {{pcf-password}}
    organization: Northwest
    space: rgadhia
    skip_cert_check: false
    current_app_name: citytest

- name: resource-app-version
  type: semver
  source:
    bucket: {{aws-bucket}}
    key: app-version
    initial_version: 1.0.0
    access_key_id: {{aws-access-key-id}}
    secret_access_key: {{aws-secret-access-key}}
    region_name: us-east-1    